<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ki originate - engine setup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .step {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
        }
        .step-active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        .step-inactive {
            background-color: white;
            color: #4b5563;
            border-color: #d1d5db;
        }
        .step-completed {
            background-color: #16a34a;
            color: white;
            border-color: #16a34a;
        }
        .screen {
            display: none;
        }
        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.2s ease-in-out;
        }
        .card-interactive:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
            border-color: #4f46e5;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #374151;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s;
        }
         .btn-secondary:hover {
            background-color: #d1d5db;
        }

        .kaleidofin-logo {
            display: inline-block;
            margin-right: 1rem;
        }

        .kaleidofin-logo svg {
            height: 32px;
            width: auto;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Decision Tree Styles */
        .tree {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            padding: 20px 0;
            width: 100%;
        }
        .tree-node {
            background-color: #eef2ff;
            border: 2px solid #818cf8;
            padding: 12px 18px;
            border-radius: 8px;
            min-width: 240px;
            text-align: center;
            position: relative;
            animation: popIn 0.5s ease-out;
        }
        .node-condition {
            font-weight: 700;
            color: #3730a3;
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        .node-metrics {
            display: flex;
            justify-content: space-around;
            font-size: 0.8rem;
            color: #4338ca;
        }
        .node-metrics div {
            display: flex;
            align-items: center;
        }
        .node-metrics .fa-check-circle { color: #16a34a; }
        .node-metrics .fa-exclamation-triangle { color: #d97706; }

        @keyframes popIn {
            0% { transform: scale(0.5); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .tree-branch {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-top: 60px;
            position: relative;
        }
        .tree-branch::before {
            content: '';
            position: absolute;
            top: -30px;
            left: 50%;
            width: 2px;
            height: 30px;
            background-color: #9ca3af;
        }
        .tree-leaf-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex-grow: 1;
        }
        .tree-leaf-container::before {
            content: '';
            position: absolute;
            top: -30px;
            height: 30px;
            width: 50%;
            border-top: 2px solid #9ca3af;
        }
        .tree-leaf-container:first-child::before {
            border-left: 2px solid #9ca3af;
            left: 50%;
            border-top-left-radius: 10px;
        }
        .tree-leaf-container:last-child::before {
            border-right: 2px solid #9ca3af;
            right: 50%;
            border-top-right-radius: 10px;
        }
        .leaf-label {
            position: absolute;
            top: -55px;
            font-size: 14px;
            font-weight: 600;
            color: #4b5563;
            background-color: #f0f2f5;
            padding: 2px 8px;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        .tree-leaf {
            padding: 10px 15px;
            border-radius: 8px;
            text-align: center;
            min-width: 150px;
            animation: popIn 0.5s ease-out 0.2s;
            animation-fill-mode: backwards;
        }
        .leaf-good {
            background-color: #dcfce7;
            border: 2px solid #4ade80;
            color: #15803d;
        }
        .leaf-bad {
            background-color: #fee2e2;
            border: 2px solid #f87171;
            color: #b91c1c;
        }
        /* Multi-select dropdown */
        .multiselect-container { position: relative; }
        .multiselect-dropdown {
            display: none;
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }
        .multiselect-dropdown label {
            display: block;
            padding: 8px 12px;
            cursor: pointer;
        }
        .multiselect-dropdown label:hover { background-color: #f3f4f6; }
        
        /* AutoML & Integration Tabs */
        .tab-btn {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6b7280;
        }
        .tab-btn.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        .evaluation-step {
            opacity: 0.5;
            transition: opacity 0.5s ease-in-out;
        }
        .evaluation-step.active {
            opacity: 1;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div id="header" class="flex items-center justify-between mb-8">
            <div class="flex items-center space-x-3">
                <div class="kaleidofin-logo">
                    <svg width="164" height="30" viewBox="0 0 164 30" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M0.105469 8.45524L17.0689 0V6.76419L0.105469 15.2194V8.45524Z" fill="#0F547E" style="fill:#0F547E;fill:color(display-p3 0.0588 0.3294 0.4941);fill-opacity:1;"/>
                        <path d="M0.105469 15.3882L17.0689 23.8434V17.0792L0.105469 8.62402V15.3882Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M38.8973 7.79234L32.7479 14.3625L39.0221 23.4083H33.9341L29.8762 17.4412L28.1593 19.2821V23.4083H24.0078V0.428711H28.1593V13.6007L33.4659 7.79234H38.8973Z" fill="#0F547E" style="fill:#0F547E;fill:color(display-p3 0.0588 0.3294 0.4941);fill-opacity:1;"/>
                        <path d="M43.7233 23.4083H39.5717V7.79236H43.7233V23.4083ZM39.0723 2.68225C39.0723 1.96282 39.322 1.34918 39.8214 0.841347C40.3208 0.312351 40.9244 0.0478516 41.6319 0.0478516C42.3394 0.0478516 42.9429 0.301771 43.4423 0.809609C43.9417 1.31744 44.1915 1.94167 44.1915 2.68225C44.1915 3.38053 43.9417 3.98359 43.4423 4.49142C42.9429 4.99927 42.3394 5.25318 41.6319 5.25318C40.9244 5.25318 40.3208 4.99927 39.8214 4.49142C39.322 3.98359 39.0723 3.38053 39.0723 2.68225Z" fill="#0F547E" style="fill:#0F547E;fill:color(display-p3 0.0588 0.3294 0.4941);fill-opacity:1;"/>
                        <path d="M63.6016 21.7378C62.0603 23.2502 60.1787 24.0064 57.9568 24.0064C55.7349 24.0064 53.8533 23.2502 52.312 21.7378C50.7707 20.2054 50 18.3348 50 16.1258C50 13.9169 50.7707 12.0562 52.312 10.5437C53.8533 9.01139 55.7349 8.24522 57.9568 8.24522C60.1787 8.24522 62.0603 9.01139 63.6016 10.5437C65.1429 12.0562 65.9136 13.9169 65.9136 16.1258C65.9136 18.3348 65.1429 20.2054 63.6016 21.7378ZM55.4947 18.6631C56.1553 19.3198 56.976 19.6482 57.9568 19.6482C58.9376 19.6482 59.7583 19.3198 60.4189 18.6631C61.0795 18.0064 61.4097 17.1606 61.4097 16.1258C61.4097 15.091 61.0795 14.2452 60.4189 13.5885C59.7583 12.9318 58.9376 12.6034 57.9568 12.6034C56.976 12.6034 56.1553 12.9318 55.4947 13.5885C54.8341 14.2452 54.5038 15.091 54.5038 16.1258C54.5038 17.1606 54.8341 18.0064 55.4947 18.6631Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M71.4636 11.3198C71.7439 10.3646 72.3043 9.63825 73.1451 9.14074C74.0058 8.62333 74.9466 8.36462 75.9675 8.36462V13.4392C74.8665 13.2601 73.8356 13.4492 72.8748 14.0064C71.934 14.5437 71.4636 15.489 71.4636 16.8422V23.5885H66.9598V8.66313H71.4636V11.3198Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M80.715 6.57358C80.1946 7.09099 79.5641 7.3497 78.8234 7.3497C78.0828 7.3497 77.4422 7.09099 76.9018 6.57358C76.3813 6.03626 76.1211 5.39945 76.1211 4.66313C76.1211 3.92681 76.3813 3.29995 76.9018 2.78253C77.4422 2.24522 78.0828 1.97656 78.8234 1.97656C79.5641 1.97656 80.1946 2.24522 80.715 2.78253C81.2555 3.29995 81.5257 3.92681 81.5257 4.66313C81.5257 5.39945 81.2555 6.03626 80.715 6.57358ZM76.5715 23.5885V8.66313H81.0753V23.5885H76.5715Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M93.8892 8.66313H98.273V22.8422C98.273 25.1905 97.5023 26.9616 95.961 28.1557C94.4197 29.3696 92.5481 29.9766 90.3462 29.9766C86.9633 29.9766 84.5913 28.7726 83.2301 26.3646L87.0734 24.1557C87.754 25.4094 88.895 26.0363 90.4963 26.0363C91.5573 26.0363 92.388 25.7577 92.9885 25.2004C93.589 24.6631 93.8892 23.8771 93.8892 22.8422V21.4691C92.8484 22.7626 91.3871 23.4094 89.5055 23.4094C87.4037 23.4094 85.6422 22.6731 84.221 21.2004C82.8198 19.7079 82.1192 17.9169 82.1192 15.8273C82.1192 13.7378 82.8198 11.9567 84.221 10.484C85.6422 8.99149 87.4037 8.24522 89.5055 8.24522C91.3871 8.24522 92.8484 8.89199 93.8892 10.1855V8.66313ZM87.6439 18.3348C88.3245 18.9716 89.1952 19.29 90.2561 19.29C91.317 19.29 92.1878 18.9716 92.8684 18.3348C93.549 17.698 93.8892 16.8621 93.8892 15.8273C93.8892 14.7925 93.549 13.9567 92.8684 13.3198C92.1878 12.683 91.317 12.3646 90.2561 12.3646C89.1952 12.3646 88.3245 12.683 87.6439 13.3198C86.9633 13.9567 86.623 14.7925 86.623 15.8273C86.623 16.8621 86.9633 17.698 87.6439 18.3348Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M104.219 6.57358C103.699 7.09099 103.068 7.3497 102.328 7.3497C101.587 7.3497 100.947 7.09099 100.406 6.57358C99.8858 6.03626 99.6255 5.39945 99.6255 4.66313C99.6255 3.92681 99.8858 3.29995 100.406 2.78253C100.947 2.24522 101.587 1.97656 102.328 1.97656C103.068 1.97656 103.699 2.24522 104.219 2.78253C104.76 3.29995 105.03 3.92681 105.03 4.66313C105.03 5.39945 104.76 6.03626 104.219 6.57358ZM100.076 23.5885V8.66313H104.58V23.5885H100.076Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M115.172 8.24522C116.773 8.24522 118.104 8.79248 119.165 9.88701C120.246 10.9815 120.787 12.494 120.787 14.4243V23.5885H116.283V15.081C116.283 14.2054 116.033 13.5388 115.532 13.081C115.052 12.6034 114.431 12.3646 113.67 12.3646C112.81 12.3646 112.129 12.6233 111.629 13.1407C111.128 13.6582 110.878 14.4243 110.878 15.4393V23.5885H106.374V8.66313H110.878V10.0661C111.779 8.85219 113.21 8.24522 115.172 8.24522Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M133.277 8.66313H137.781V23.5885H133.277V22.1855C132.217 23.3995 130.725 24.0064 128.804 24.0064C126.822 24.0064 125.131 23.2502 123.729 21.7378C122.328 20.2054 121.628 18.3348 121.628 16.1258C121.628 13.9169 122.328 12.0562 123.729 10.5437C125.131 9.01139 126.822 8.24522 128.804 8.24522C130.725 8.24522 132.217 8.85219 133.277 10.0661V8.66313ZM127.122 18.7825C127.783 19.4393 128.644 19.7676 129.704 19.7676C130.765 19.7676 131.626 19.4393 132.287 18.7825C132.947 18.1258 133.277 17.2402 133.277 16.1258C133.277 15.0114 132.947 14.1258 132.287 13.4691C131.626 12.8124 130.765 12.484 129.704 12.484C128.644 12.484 127.783 12.8124 127.122 13.4691C126.462 14.1258 126.131 15.0114 126.131 16.1258C126.131 17.2402 126.462 18.1258 127.122 18.7825Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M148.382 12.9616H145.289V18.2452C148.382 18.8422 145.529 19.2203 146.01 19.3795C146.49 19.5388 147.281 19.5885 148.382 19.5288V23.5885C145.519 23.887 143.538 23.6184 142.437 22.7825C141.336 21.9268 140.785 20.4144 140.785 18.2452V12.9616H138.383V8.66313H140.785V5.82731L145.289 4.48403V8.66313H148.382V12.9616Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                        <path d="M153.161 17.9169C153.681 19.3099 154.882 20.0064 156.764 20.0064C157.985 20.0064 158.946 19.6283 159.646 18.8721L163.249 20.9318C161.768 22.9815 159.586 24.0064 156.704 24.0064C154.182 24.0064 152.16 23.2601 150.639 21.7676C149.137 20.2751 148.387 18.3945 148.387 16.1258C148.387 13.8771 149.127 12.0064 150.609 10.5139C152.11 9.00144 154.032 8.24522 156.373 8.24522C158.555 8.24522 160.367 9.00144 161.808 10.5139C163.269 12.0064 164 13.8771 164 16.1258C164 16.7626 163.94 17.3596 163.82 17.9169H153.161ZM153.071 14.5736H159.526C159.086 13.0014 158.025 12.2154 156.343 12.2154C154.602 12.2154 153.511 13.0014 153.071 14.5736Z" fill="#28B2B6" style="fill:#28B2B6;fill:color(display-p3 0.1569 0.6980 0.7137);fill-opacity:1;"/>
                    </svg>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="bg-indigo-600 text-white p-3 rounded-lg">
                        <i class="fas fa-cogs fa-2x"></i>
                    </div>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Engine Setup</h1>
                        <p class="text-gray-500">Interactive Credit Decisioning Platform</p>
                    </div>
                </div>
            </div>
            <button id="home-btn" class="btn-secondary" onclick="window.location.href='africa-home.html'"><i class="fas fa-home mr-2"></i>Home</button>
        </div>

        <!-- Main Content Area -->
        <div id="main-content" class="bg-white p-6 md:p-8 rounded-xl shadow-lg min-h-[600px]">
            
            <!-- Screen 0: Strategy Choice -->
            <div id="screen-0" class="screen active">
                <h2 class="text-2xl font-bold text-gray-800 mb-2 text-center">Choose Your Strategy Path</h2>
                <p class="text-gray-600 mb-8 text-center max-w-2xl mx-auto">Start by selecting a battle-tested universal model for immediate deployment, or walk through the process of building a completely new model tailored to your data.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 max-w-4xl mx-auto">
                    <div id="path-universal" class="card card-interactive p-8 text-center cursor-pointer border-2 border-transparent">
                        <i class="fas fa-globe-americas text-5xl text-indigo-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Use a Pre-Built Model</h3>
                        <p class="text-gray-500">Select from our library of high-performance, asset-class specific models. Get started in minutes.</p>
                    </div>
                    <div id="path-custom" class="card card-interactive p-8 text-center cursor-pointer border-2 border-transparent">
                        <i class="fas fa-tools text-5xl text-green-500 mb-4"></i>
                        <h3 class="text-xl font-bold text-gray-800 mb-2">Build a Custom Model</h3>
                        <p class="text-gray-500">A step-by-step journey to ingest your data, train a new AI model, and define custom fail-safe rules.</p>
                    </div>
                </div>
            </div>

            <!-- Stepper (for custom path) -->
            <div id="stepper-container" class="hidden grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                <div id="step-1-indicator" class="step step-active flex items-center p-4 rounded-lg border-2">
                    <div class="text-xl mr-4"><i class="fas fa-database"></i></div>
                    <div><p class="font-bold">Step 1</p><p class="text-sm">Data Ingestion</p></div>
                </div>
                <div id="step-2-indicator" class="step step-inactive flex items-center p-4 rounded-lg border-2">
                    <div class="text-xl mr-4"><i class="fas fa-magic"></i></div>
                    <div><p class="font-bold">Step 2</p><p class="text-sm">Model Building</p></div>
                </div>
                <div id="step-3-indicator" class="step step-inactive flex items-center p-4 rounded-lg border-2">
                    <div class="text-xl mr-4"><i class="fas fa-shield-alt"></i></div>
                    <div><p class="font-bold">Step 3</p><p class="text-sm">Fail-Safe Rules</p></div>
                </div>
                 <div id="step-4-indicator" class="step step-inactive flex items-center p-4 rounded-lg border-2">
                    <div class="text-xl mr-4"><i class="fas fa-flag-checkered"></i></div>
                    <div><p class="font-bold">Step 4</p><p class="text-sm">Finish</p></div>
                </div>
            </div>
            
            <!-- Screen 1 (Universal Model) -->
            <div id="screen-1" class="screen">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Engine Setup: Universal Model</h2>
                <p class="text-gray-600 mb-6">Select a pre-built model and see the immediate performance lift against a legacy strategy.</p>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div>
                        <div class="card p-6">
                            <h3 class="font-bold text-lg mb-4 text-gray-700">1. Select Your Base Model</h3>
                            <select id="model-selector" class="w-full p-3 border rounded-lg bg-gray-50 mb-6">
                                <option value="digital_loan">Digital Loan (Kenya)</option>
                                <option value="microfinance">Microfinance Loan</option>
                                <option value="agriculture">Agriculture Loan</option>
                                <option value="msme">MSME Loan</option>
                                <option value="mobile_money">Mobile Money Loan</option>
                            </select>
                            <h3 class="font-bold text-lg mb-4 text-gray-700">2. Included Data Sources</h3>
                            <p class="text-gray-500">Configure your credit decisioning engine with pre-built models or build custom AI models from your data.</p>
                        </div>
                    </div>
                    <div>
                        <div class="card p-6">
                            <h3 class="font-bold text-lg mb-4 text-gray-700">Predicted Performance Lift</h3>
                            <div id="performance-chart"></div>
                            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mt-6 text-center">
                                <div><p class="text-gray-500 text-sm">Approval Rate</p><p id="approval-rate" class="text-2xl font-bold text-green-600">85%</p><p class="text-xs text-gray-400">vs 65% Legacy</p></div>
                                <div><p class="text-gray-500 text-sm">Default Rate</p><p id="default-rate" class="text-2xl font-bold text-red-600">1.8%</p><p class="text-xs text-gray-400">vs 3.2% Legacy</p></div>
                                <div><p class="text-gray-500 text-sm">Gini Coefficient</p><p id="gini-coef" class="text-2xl font-bold text-indigo-600">0.82</p><p class="text-xs text-gray-400">vs 0.62 Legacy</p></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-8 text-center">
                    <button id="back-to-options-1" class="btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back to Options</button>
                </div>
            </div>

            <!-- Screen 2 (Custom Path - Step 1) -->
            <div id="screen-2" class="screen">
                 <h2 class="text-2xl font-bold text-gray-800 mb-2">Step 1: Data Ingestion & Mapping</h2>
                <p class="text-gray-600 mb-6">Upload your historical data files. We'll guide you through mapping the columns to our system for analysis.</p>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div id="upload-bureau" class="card p-6"><div class="flex items-center mb-4"><i class="fas fa-university text-indigo-600 text-2xl mr-4"></i><h3 class="font-bold text-lg text-gray-700">Credit Bureau Data</h3></div><p class="text-sm text-gray-500 mb-4">Upload your historical credit bureau reports.</p><button class="w-full btn-secondary"><i class="fas fa-upload mr-2"></i> Upload File</button></div>
                    <div id="upload-bank" class="card p-6"><div class="flex items-center mb-4"><i class="fas fa-file-invoice-dollar text-green-600 text-2xl mr-4"></i><h3 class="font-bold text-lg text-gray-700">Bank Statements</h3></div><p class="text-sm text-gray-500 mb-4">Upload parsed bank statement data.</p><button class="w-full btn-secondary"><i class="fas fa-upload mr-2"></i> Upload File</button></div>
                    <div id="upload-alt" class="card p-6"><div class="flex items-center mb-4"><i class="fas fa-satellite-dish text-purple-600 text-2xl mr-4"></i><h3 class="font-bold text-lg text-gray-700">Alternative Data</h3></div><p class="text-sm text-gray-500 mb-4">Upload telco or mobile money statements.</p><button class="w-full btn-secondary"><i class="fas fa-upload mr-2"></i> Upload File</button></div>
                </div>
                <div class="mt-8 text-right flex justify-between items-center">
                    <button id="back-to-options-2" class="btn-secondary"><i class="fas fa-arrow-left mr-2"></i> Back to Options</button>
                    <button id="ingestion-next-btn" class="btn-primary opacity-50" disabled>Build Model <i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>
            
            <!-- Screen 3 (Custom Path - Step 2) -->
            <div id="screen-3" class="screen">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Step 2: Automated Model Building</h2>
                <div id="automl-setup">
                    <p class="text-gray-600 mb-6">Configure your modeling experiment. Select the target variable you want to predict from your dataset.</p>
                    <div class="card p-6">
                        <h3 class="font-bold text-lg mb-4 text-gray-700">Experiment Configuration</h3>
                        <label for="target-variable" class="block font-semibold text-gray-600 mb-2">Select Target Variable (What to predict):</label>
                        <select id="target-variable" class="w-full p-3 border rounded-lg bg-gray-50 mb-6">
                            <option>default_status</option>
                            <option>paid_on_time</option>
                            <option>par_90</option>
                        </select>
                        <button id="start-automl-btn" class="btn-primary w-full"><i class="fas fa-play-circle mr-2"></i>Start AutoML Experiment</button>
                    </div>
                </div>
                <div id="automl-inprogress" class="hidden">
                    <div class="border-b border-gray-200 mb-4">
                        <nav class="flex -mb-px" id="automl-tabs">
                            <button class="tab-btn active" data-tab="progress">Live Progress</button>
                            <button class="tab-btn" data-tab="features">Generated Features</button>
                            <button class="tab-btn" data-tab="models">Model Trials</button>
                        </nav>
                    </div>
                    <div id="progress-tab" class="tab-content active">
                        <div class="card p-8 text-center"><div id="model-building-progress"><div class="loader mx-auto mb-4"></div><p class="text-lg font-semibold text-gray-700 mb-2">Running Experiment...</p><p id="progress-text" class="text-gray-500">Initializing...</p></div></div>
                    </div>
                    <div id="features-tab" class="tab-content">
                        <div class="card p-6"><h3 class="font-bold text-lg mb-4">Automatically Generated Features</h3><div class="max-h-96 overflow-y-auto"><table class="w-full text-sm"><thead><tr class="text-left bg-gray-50"><th class="p-2">Feature Name</th><th class="p-2">Type</th><th class="p-2">Source</th></tr></thead><tbody id="features-table"></tbody></table></div></div>
                    </div>
                    <div id="models-tab" class="tab-content">
                        <div class="card p-6"><h3 class="font-bold text-lg mb-4">Model Trials Leaderboard</h3><div class="max-h-96 overflow-y-auto"><table class="w-full text-sm"><thead><tr class="text-left bg-gray-50"><th class="p-2">Rank</th><th class="p-2">Algorithm</th><th class="p-2">Gini</th><th class="p-2">Status</th></tr></thead><tbody id="models-table"></tbody></table></div></div>
                    </div>
                    <div id="automl-finalize-cta" class="text-center mt-6 hidden">
                        <button id="finalize-model-btn" class="btn-primary bg-green-600 hover:bg-green-700">
                            <i class="fas fa-trophy mr-2"></i> View Champion Model & Finalize
                        </button>
                    </div>
                </div>
                <div id="automl-complete" class="hidden card p-8 text-center mt-6">
                    <i class="fas fa-check-circle text-green-500 text-6xl mx-auto mb-4"></i><h3 class="text-2xl font-bold text-gray-800 mb-2">Champion Model Selected!</h3><p class="text-gray-600 mb-6">The AutoML run is complete. We've selected the best performing model based on the Gini coefficient.</p><div class="card bg-gray-50 p-6 mt-6 text-left"><h4 class="font-bold text-lg mb-4">Champion Model: XGBoost Classifier</h4><div class="grid grid-cols-2 md:grid-cols-4 gap-4"><div><p class="text-sm text-gray-500">AUC-ROC</p><p class="text-2xl font-bold">0.89</p></div><div><p class="text-sm text-gray-500">Gini</p><p class="text-2xl font-bold">0.78</p></div><div><p class="text-sm text-gray-500">Precision</p><p class="text-2xl font-bold">0.82</p></div><div><p class="text-sm text-gray-500">Recall</p><p class="text-2xl font-bold">0.75</p></div></div></div>
                </div>
                <div class="mt-8 text-right flex justify-between items-center">
                    <button class="btn-secondary back-btn"><i class="fas fa-arrow-left mr-2"></i> Back to Data Ingestion</button>
                    <button id="rules-next-btn" class="btn-primary hidden">Configure Fail-Safe Rules <i class="fas fa-arrow-right ml-2"></i></button>
                </div>
            </div>

            <!-- Screen 4 (Custom Path - Step 3) -->
            <div id="screen-4" class="screen">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Step 3: Configure Fail-Safe Rules</h2>
                <p class="text-gray-600 mb-6">Visually build your fail-safe rules. Our Decision Tree engine will find the optimal cutoffs for your most critical guardrail variables.</p>
                <div class="card p-6 mb-8">
                    <h3 class="font-bold text-lg mb-4 text-gray-700">1. Decision Tree Builder</h3>
                    <div class="bg-gray-50 p-4 rounded-lg border">
                        <p class="font-semibold mb-3">Select features for your fail-safe rules:</p>
                        <div class="multiselect-container"><div id="multiselect-input" class="w-full p-3 border rounded-lg bg-white cursor-pointer flex justify-between items-center"><span id="multiselect-text">Select variables...</span><i class="fas fa-chevron-down"></i></div><div id="multiselect-dropdown" class="multiselect-dropdown"></div></div>
                        <button id="build-tree-btn" class="w-full btn-primary mt-4"><i class="fas fa-sitemap mr-2"></i>Build & Visualize Rules</button>
                    </div>
                </div>
                <div id="tree-section" class="hidden">
                    <div class="card p-6 mb-8"><h3 class="font-bold text-lg mb-4 text-gray-700">Visualized Decision Tree</h3><div id="tree-container" class="min-h-[300px] flex items-center justify-center overflow-x-auto"></div></div>
                    <div id="rule-workbench-container" class="card p-6"><h3 class="font-bold text-lg mb-4 text-gray-700">2. Rule Workbench</h3><div id="workbench-rules" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div><div class="mt-6 text-right"><button id="simulate-rules-btn" class="btn-primary bg-green-600 hover:bg-green-700"><i class="fas fa-sync-alt mr-2"></i>Simulate & Rebuild Tree</button></div></div>
                </div>
                <div class="mt-8 text-right flex justify-between items-center">
                    <button class="btn-secondary back-btn"><i class="fas fa-arrow-left mr-2"></i> Back to Model</button>
                    <button class="btn-primary next-btn">Finish & View Summary <i class="fas fa-flag-checkered ml-2"></i></button>
                </div>
            </div>
            
            <!-- Screen 5 (Custom Path - Step 4) -->
            <div id="screen-5" class="screen">
                 <div class="card p-8 text-center">
                    <i class="fas fa-rocket text-green-500 text-6xl mx-auto mb-4"></i>
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Strategy Configured & Ready!</h2>
                    <p class="text-gray-600 mb-6 max-w-2xl mx-auto">You have successfully built a powerful, two-layer credit decisioning strategy. The combination of your AI-driven Ki-Score and your custom fail-safe rules is now ready for deployment.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto mt-8 text-left">
                        <div class="bg-gray-50 p-6 rounded-lg border"><h4 class="font-bold text-lg mb-3 flex items-center"><i class="fas fa-brain text-indigo-500 mr-3"></i>Primary Model</h4><p><strong>Type:</strong> XGBoost Classifier</p><p><strong>Gini:</strong> 0.78</p><p><strong>Top Feature:</strong> cash_inflow_volatility</p></div>
                        <div class="bg-gray-50 p-6 rounded-lg border"><h4 class="font-bold text-lg mb-3 flex items-center"><i class="fas fa-shield-alt text-red-500 mr-3"></i>Fail-Safe Rules</h4><div id="summary-rules-list"></div></div>
                    </div>
                    <button id="start-over-btn" class="btn-primary mt-10"><i class="fas fa-redo mr-2"></i> Start Over</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Upload Modal -->
    <div id="upload-modal" class="fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl transform transition-all"><div class="p-6"><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-bold text-gray-800" id="modal-title">Upload File</h3><button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">&times;</button></div><div id="upload-view"></div><div id="mapping-view" class="hidden"><p class="text-gray-600 mb-4">Please map the columns from your file to our required fields.</p><div class="max-h-96 overflow-y-auto pr-2"><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-3 font-semibold">Your File Column</th><th class="p-3 font-semibold">Required System Field</th></tr></thead><tbody id="mapping-table-body"></tbody></table></div><div class="mt-6 text-right"><button id="confirm-mapping-btn" class="btn-primary">Confirm Mapping</button></div></div></div></div>
    </div>

<script>
    let currentPath = '';
    let currentStep = 1;
    let uploadedFiles = {};
    let currentUploadType = '';
    let originalUploadViewHTML = '';
    let perfChart;

    const allRuleVariables = [
        'DTI / FOIR', 'LTV Ratio', 'Bureau Score', 'Applicant Age', 'Loan Amount', 'Loan Tenure',
        'DPD 90+ Count (Ever)', 'DPD 60+ Count (Last 12M)', 'DPD 30+ Count (Last 6M)',
        'Number of Inquiries (Last 3M)', 'Time Since First Loan', 'Avg. Monthly Inflow',
        'Avg. Monthly Surplus', 'Cashflow Volatility', 'Salary Credit Count', 'SIM Tenure',
        'Device Age', 'Business Vintage', 'Number of Employees', 'Collateral Coverage Ratio'
    ];
    const variableData = {
        'DTI / FOIR': { op: '>', value: 55, unit: '%' },
        'LTV Ratio': { op: '>', value: 85, unit: '%' },
        'Bureau Score': { op: '<', value: 680, unit: '' },
        'Applicant Age': { op: '<', value: 21, unit: 'yrs' },
        'Loan Amount': { op: '>', value: 2500000, unit: 'â‚¹' },
        'DPD 90+ Count (Ever)': { op: '>', value: 0, unit: '' },
        'Number of Inquiries (Last 3M)': { op: '>', value: 5, unit: '' },
    };

    const mockData = {
        bureau: { headers: ['customer_id', 'cibil_score', 'dpd_90_plus', 'active_loans', 'default_status'] },
        bank: { headers: ['cust_id', 'avg_monthly_inflow', 'avg_monthly_outflow', 'salary_credits'] },
        alt: { headers: ['phone_number', 'sim_tenure', 'avg_upi_txn_amt'] }
    };
    const systemFields = {
        bureau: ['Customer ID', 'Bureau Score', '90+ DPD Count', 'Active Loan Count', 'Default Status'],
        bank: ['Customer ID', 'Avg Monthly Inflow', 'Avg Monthly Outflow', 'Salary Credit Count'],
        alt: ['Phone Number', 'SIM Tenure (Months)', 'Avg UPI Txn Amount']
    };

    function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        const screenToShow = document.getElementById(`screen-${screenId}`);
        if(screenToShow) screenToShow.classList.add('active');

        const stepper = document.getElementById('stepper-container');
        if (screenId === '0' || screenId === '1' ) {
             stepper.style.display = 'none';
        } else {
             stepper.style.display = 'grid';
        }

        const homeBtn = document.getElementById('home-btn');
        // Always show home button now
        homeBtn.style.display = 'block';
    }

    function selectPath(path) {
        currentPath = path;
        if (path === 'universal') {
            // Redirect to Africa model selector page for pre-built model path
            window.location.href = 'africa-model-selector.html';
        } else if (path === 'custom') {
            // Redirect to Africa custom model builder page
            window.location.href = 'africa-custom-model-builder.html';
        } else {
             showScreen('0');
        }
    }



    function goToStep(step) {
        if(step > 0 && step <= 5){
            for (let i = 1; i <= 4; i++) {
                const indicator = document.getElementById(`step-${i}-indicator`);
                indicator.classList.remove('step-active', 'step-completed', 'step-inactive');
                if (i < step) indicator.classList.add('step-completed');
                else if (i === step) indicator.classList.add('step-active');
                else indicator.classList.add('step-inactive');
            }
             if(step === 4) { // Finish step
                 finishDemo();
                 showScreen(5);
             } else {
                 const screenId = step + 1; // screen-2 is step 1, etc.
                 showScreen(screenId);
             }
            currentStep = step;
        }
    }

    function openUploadModal(type) {
        currentUploadType = type;
        const modal = document.getElementById('upload-modal');
        modal.classList.remove('hidden');
        const uploadView = document.getElementById('upload-view');
        uploadView.innerHTML = `<div class="text-center p-12"><div class="loader mx-auto mb-4"></div><p class="font-semibold text-gray-700">Simulating file upload...</p></div>`;
        document.getElementById('modal-title').innerText = `Upload ${type.charAt(0).toUpperCase() + type.slice(1)} Data`;
        setTimeout(() => {
            populateMappingTable(mockData[type].headers);
            document.getElementById('upload-view').style.display = 'none';
            document.getElementById('mapping-view').style.display = 'block';
        }, 1500);
    }

    function closeUploadModal() {
        document.getElementById('upload-modal').classList.add('hidden');
        document.getElementById('mapping-view').style.display = 'none';
        document.getElementById('upload-view').style.display = 'block';
    }

    function populateMappingTable(headers) {
        const tableBody = document.getElementById('mapping-table-body');
        tableBody.innerHTML = '';
        const required = systemFields[currentUploadType];
        headers.forEach((header, index) => {
            tableBody.innerHTML += `<tr class="border-b"><td class="p-3 bg-indigo-50">${header}</td><td class="p-3"><select class="w-full p-2 border rounded-md">${required.map((field, i) => `<option value="${field}" ${i === index ? 'selected' : ''}>${field}</option>`).join('')}<option>-- Ignore --</option></select></td></tr>`;
        });
    }

    function confirmMapping() {
        uploadedFiles[currentUploadType] = true;
        const card = document.getElementById(`upload-${currentUploadType}`);
        card.classList.add('border-2', 'border-green-500');
        card.querySelector('button').innerHTML = `<i class="fas fa-check-circle mr-2"></i> File Uploaded`;
        card.querySelector('button').classList.remove('btn-secondary');
        card.querySelector('button').classList.add('bg-green-100', 'text-green-800');
        card.querySelector('button').disabled = true;
        closeUploadModal();
        checkAllFilesUploaded();
    }

    function checkAllFilesUploaded() {
        if (uploadedFiles.bureau && uploadedFiles.bank && uploadedFiles.alt) {
            const nextBtn = document.getElementById('ingestion-next-btn');
            nextBtn.disabled = false;
            nextBtn.classList.remove('opacity-50');
        }
    }
    
    function startModelBuilding() {
        document.getElementById('automl-setup').style.display = 'none';
        document.getElementById('automl-inprogress').style.display = 'block';
        document.getElementById('features-table').innerHTML = '';
        document.getElementById('models-table').innerHTML = '';

        const progressText = document.getElementById('progress-text');
        const features = [
            { name: 'bureau_score_x_loan_amt', type: 'Interaction', source: 'Bureau, Input' },
            { name: 'avg_inflow_last_3m', type: 'Aggregation', source: 'Bank' },
            { name: 'inflow_volatility', type: 'Aggregation', source: 'Bank' },
            { name: 'sim_tenure_months', type: 'Temporal', source: 'Telco' },
            { name: 'inquiry_to_loan_ratio', type: 'Ratio', source: 'Bureau' },
            { name: 'upi_txn_frequency', type: 'Temporal', source: 'Bank' },
            { name: 'salary_credit_stability', type: 'Aggregation', source: 'Bank' },
        ];
        const models = [
            { name: 'LightGBM Classifier', gini: 0.76 },
            { name: 'Logistic Regression', gini: 0.65 },
            { name: 'Random Forest', gini: 0.72 },
            { name: 'XGBoost Classifier', gini: 0.78 }
        ];

        setTimeout(() => {
            progressText.innerText = 'Generating Features...';
            const featuresTable = document.getElementById('features-table');
            features.forEach(f => {
                featuresTable.innerHTML += `<tr><td class="p-2">${f.name}</td><td class="p-2">${f.type}</td><td class="p-2">${f.source}</td></tr>`;
            });

            setTimeout(() => {
                progressText.innerText = 'Running Model Trials...';
                const modelsTable = document.getElementById('models-table');
                let modelIndex = 0;
                const modelInterval = setInterval(() => {
                    if(modelIndex < models.length) {
                        const m = models[modelIndex];
                        modelsTable.innerHTML += `<tr><td class="p-2 font-bold">#${modelIndex+1}</td><td class="p-2">${m.name}</td><td class="p-2 font-semibold">${m.gini}</td><td class="p-2 text-blue-600">Running...</td></tr>`;
                        modelIndex++;
                    } else {
                        clearInterval(modelInterval);
                        progressText.innerText = 'Finalizing Champion Model...';
                        models.sort((a,b) => b.gini - a.gini);
                        modelsTable.innerHTML = '';
                        models.forEach((m, i) => {
                            modelsTable.innerHTML += `<tr><td class="p-2 font-bold">${i+1}</td><td class="p-2">${m.name} ${i===0 ? '<span class="text-xs bg-green-200 text-green-800 font-bold p-1 rounded">CHAMPION</span>' : ''}</td><td class="p-2 font-semibold">${m.gini}</td><td class="p-2 text-green-600">Completed</td></tr>`;
                        });
                        document.getElementById('model-building-progress').innerHTML = `<i class="fas fa-check-circle text-green-500 text-5xl mb-4"></i><p class="text-lg font-semibold text-gray-700">Experiment Complete!</p>`;
                        document.getElementById('automl-finalize-cta').style.display = 'block';
                    }
                }, 800);
            }, 1500);
        }, 1500);
    }
    
    function finalizeModelBuilding() {
        document.getElementById('automl-inprogress').style.display = 'none';
        document.getElementById('automl-complete').style.display = 'block';
        document.getElementById('rules-next-btn').style.display = 'inline-block';
    }

    function getSelectedRules() {
        return Array.from(document.querySelectorAll('#multiselect-dropdown input:checked')).map(cb => cb.value);
    }

    function generateTreeNode(variable, approval, defaultRate, animationDelay, isSimulation = false) {
        const ruleId = variable.toLowerCase().replace(/[^a-z0-9]/g, '');
        const valueInput = document.getElementById(`${ruleId}-value`);
        const value = isSimulation && valueInput ? valueInput.value : variableData[variable].value;
        const data = variableData[variable];
        return `
            <div class="tree-node" style="animation-delay: ${animationDelay}s;">
                <div class="node-condition">${variable} ${data.op} ${value}${data.unit}</div>
                <div class="node-metrics">
                    <div><i class="fas fa-check-circle mr-1"></i>${approval}% Appr.</div>
                    <div><i class="fas fa-exclamation-triangle mr-1"></i>${defaultRate}% Def.</div>
                </div>
            </div>
        `;
    }

    function buildDecisionTree(isSimulation = false) {
        const treeContainer = document.getElementById('tree-container');
        const buildBtn = document.getElementById('build-tree-btn');
        buildBtn.innerHTML = `<div class="loader !w-5 !h-5 !border-2 mx-auto"></div>`;
        buildBtn.disabled = true;
        treeContainer.innerHTML = '';
        if(!isSimulation) document.getElementById('tree-section').style.display = 'none';

        setTimeout(() => {
            const selectedRules = getSelectedRules();
            if (selectedRules.length === 0) {
                treeContainer.innerHTML = `<p class="text-gray-500">Please select at least one variable to build the tree.</p>`;
                buildBtn.innerHTML = `<i class="fas fa-sitemap mr-2"></i>Build & Visualize Rules`;
                buildBtn.disabled = false;
                return;
            }

            let treeHTML = '';
            let approval = 70.0;
            let defaultRate = 3.0;
            let diminishingFactor = 1;
            let lastRule = '';
            let currentTreeLevel = ``;

            selectedRules.forEach((rule, index) => {
                const ruleId = rule.toLowerCase().replace(/[^a-z0-9]/g, '');
                const valueInput = document.getElementById(`${ruleId}-value`);
                const currentValue = valueInput ? parseFloat(valueInput.value) : variableData[rule].value;
                const baseValue = variableData[rule].value;
                const valueEffect = (currentValue - baseValue) * (variableData[rule].op === '>' ? -0.1 : 0.1);
                approval -= ((5 / diminishingFactor) + valueEffect);
                defaultRate -= ((0.8 / diminishingFactor) + (valueEffect / 5));
                diminishingFactor += 0.5;
                const nodeHTML = generateTreeNode(rule, approval.toFixed(1), defaultRate.toFixed(1), (index * 0.1), isSimulation);
                lastRule = rule;

                if (index === 0) {
                    currentTreeLevel = nodeHTML;
                } else {
                    currentTreeLevel = `
                        ${currentTreeLevel}
                        <div class="tree-branch w-full">
                            <div class="tree-leaf-container">
                                <div class="leaf-label">Pass</div>
                                ${nodeHTML}
                            </div>
                            <div class="tree-leaf-container">
                                <div class="leaf-label">Fail</div>
                                <div class="tree-leaf leaf-bad" style="animation-delay: ${ (index * 0.1) + 0.1 }s;">
                                    <strong>Reject</strong>
                                    <p class="text-xs">${selectedRules[index-1]}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            treeHTML = `
                <div class="tree">
                    ${currentTreeLevel}
                    <div class="tree-branch w-full">
                        <div class="tree-leaf-container">
                            <div class="leaf-label">Pass</div>
                            <div class="tree-leaf leaf-good" style="animation-delay: ${selectedRules.length * 0.1}s;">
                                <strong>Approve</strong>
                                <p class="text-xs font-semibold">${defaultRate.toFixed(1)}% Default</p>
                            </div>
                        </div>
                        <div class="tree-leaf-container">
                            <div class="leaf-label">Fail</div>
                            <div class="tree-leaf leaf-bad" style="animation-delay: ${ (selectedRules.length * 0.1) + 0.1 }s;">
                                <strong>Reject</strong>
                                <p class="text-xs">${lastRule}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            treeContainer.innerHTML = treeHTML;
            
            if (!isSimulation) populateWorkbench(selectedRules);
            document.getElementById('tree-section').style.display = 'block';
            buildBtn.innerHTML = `<i class="fas fa-check mr-2"></i> Rules Built`;
            buildBtn.classList.add('bg-green-600');
            buildBtn.disabled = false;
        }, 1500);
    }
    
    function populateWorkbench(rules) {
        const workbench = document.getElementById('rule-workbench-container');
        const rulesContainer = document.getElementById('workbench-rules');
        rulesContainer.innerHTML = '';

        rules.forEach(rule => {
            const data = variableData[rule];
            const ruleId = rule.toLowerCase().replace(/[^a-z0-9]/g, '');
            const ruleHTML = `<div class="p-4 border rounded-lg bg-white"><label class="font-semibold text-gray-800">${rule}</label><div class="flex items-center space-x-4 mt-2"><span class="font-mono">${data.op}</span><input type="range" id="${ruleId}-slider" min="${data.value - 20}" max="${data.value + 20}" value="${data.value}" class="w-full"><input type="number" id="${ruleId}-value" value="${data.value}" class="w-24 p-2 border rounded-md text-center"><span>${data.unit}</span></div></div>`;
            rulesContainer.innerHTML += ruleHTML;
        });

        rules.forEach(rule => {
            const ruleId = rule.toLowerCase().replace(/[^a-z0-9]/g, '');
            const slider = document.getElementById(`${ruleId}-slider`);
            const valueInput = document.getElementById(`${ruleId}-value`);
            slider.oninput = () => valueInput.value = slider.value;
            valueInput.onchange = () => slider.value = valueInput.value;
        });
    }

    function simulateRules() {
        const simBtn = document.getElementById('simulate-rules-btn');
        simBtn.innerHTML = `<div class="loader !w-5 !h-5 !border-2 mx-auto"></div>`;
        simBtn.disabled = true;
        buildDecisionTree(true);
        setTimeout(() => {
            simBtn.innerHTML = `<i class="fas fa-sync-alt mr-2"></i>Simulate & Rebuild Tree`;
            simBtn.disabled = false;
        }, 2000);
    }
    
    function finishDemo() {
        const rulesList = document.getElementById('summary-rules-list');
        rulesList.innerHTML = '';
        const selectedRules = getSelectedRules();
        if (selectedRules.length > 0 && document.getElementById('tree-section').style.display !== 'none') {
            selectedRules.forEach(rule => {
                const ruleId = rule.toLowerCase().replace(/[^a-z0-9]/g, '');
                const valueEl = document.getElementById(`${ruleId}-value`);
                if (valueEl) {
                    const value = valueEl.value;
                    const data = variableData[rule];
                    rulesList.innerHTML += `<p><strong>${rule}:</strong> <span class="font-mono text-indigo-600">${data.op} ${value}${data.unit}</span></p>`;
                }
            });
        } else {
            rulesList.innerHTML = '<p>No fail-safe rules configured.</p>';
        }
        goToStep(4);
    }
    
    function switchTab(event, tabName) {
        const tabContainer = event.target.closest('#automl-inprogress');
        if (tabContainer) {
            tabContainer.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
            tabContainer.querySelector(`#${tabName}-tab`).classList.add('active');
            tabContainer.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
    }

    function initListeners() {
        // Path Selection
        document.getElementById('path-universal').addEventListener('click', () => selectPath('universal'));
        document.getElementById('path-custom').addEventListener('click', () => selectPath('custom'));

        // Back buttons
        document.getElementById('back-to-options-1').addEventListener('click', () => showScreen('0'));
        document.getElementById('back-to-options-2').addEventListener('click', () => showScreen('0'));
        document.querySelectorAll('.back-btn').forEach(btn => btn.addEventListener('click', () => goToStep(currentStep - 1)));

        // Step 1: Ingestion
        document.querySelectorAll('#upload-bureau button, #upload-bank button, #upload-alt button').forEach(btn => {
            const type = btn.closest('.card').id.replace('upload-', '');
            btn.addEventListener('click', () => openUploadModal(type));
        });
        document.getElementById('close-modal-btn').addEventListener('click', closeUploadModal);
        document.getElementById('confirm-mapping-btn').addEventListener('click', confirmMapping);
        document.getElementById('ingestion-next-btn').addEventListener('click', () => goToStep(2));
        
        // Step 2: Model Building
        document.getElementById('start-automl-btn').addEventListener('click', startModelBuilding);
        document.getElementById('finalize-model-btn').addEventListener('click', finalizeModelBuilding);
        document.getElementById('rules-next-btn').addEventListener('click', () => goToStep(3));
        document.querySelectorAll('#automl-tabs .tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => switchTab(e, e.currentTarget.dataset.tab));
        });

        // Step 3: Rules
        document.getElementById('build-tree-btn').addEventListener('click', () => buildDecisionTree(false));
        document.getElementById('simulate-rules-btn').addEventListener('click', simulateRules);
        document.querySelectorAll('.next-btn').forEach(btn => btn.addEventListener('click', () => goToStep(currentStep + 1)));

        // Step 4: Finish
        document.getElementById('start-over-btn').addEventListener('click', () => {
            uploadedFiles = {};
            document.querySelectorAll('#screen-2 .card').forEach(c => {
                 c.classList.remove('border-2', 'border-green-500');
                 const btn = c.querySelector('button');
                 btn.innerHTML = `<i class="fas fa-upload mr-2"></i> Upload File`;
                 btn.classList.add('btn-secondary');
                 btn.classList.remove('bg-green-100', 'text-green-800');
                 btn.disabled = false;
            });
            document.getElementById('ingestion-next-btn').disabled = true;
            document.getElementById('ingestion-next-btn').classList.add('opacity-50');
            showScreen('0');
        });
        
        // Stepper Navigation
        document.querySelectorAll('.step').forEach(stepIndicator => {
            stepIndicator.addEventListener('click', () => {
                const stepNum = parseInt(stepIndicator.id.split('-')[1]);
                goToStep(stepNum);
            });
        });

        // Home button
        document.getElementById('home-btn').addEventListener('click', () => {
            showScreen('0');
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Auto-redirect to pre-built model flow (same as India)
        selectPath('universal');
    });
</script>
</body>
</html>

